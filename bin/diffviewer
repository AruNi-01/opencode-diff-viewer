#!/usr/bin/env node

const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');

const CONFIG_FILE = path.join(process.env.HOME || process.env.USERPROFILE, '.config', 'diffviewer', 'config.json');

// é»˜è®¤å·¥å…·é…ç½®
const DEFAULT_TOOLS = {
  opencode: {
    name: 'OpenCode',
    command: 'opencode',
    description: 'AI-powered code editor',
    install: 'npm install -g @opencode-ai/opencode'
  },
  claude: {
    name: 'Claude CLI',
    command: 'claude',
    description: 'Anthropic CLI',
    install: 'npm install -g @anthropic-ai/claude'
  },
  codex: {
    name: 'Codex CLI',
    command: 'codex',
    description: 'OpenAI CLI',
    install: 'npm install -g openai'
  },
  lumen: {
    name: 'Lumen',
    command: 'lumen diff',
    description: 'TUI Diff Viewer',
    install: 'brew install jnsahaj/lumen/lumen'
  }
};

// åŠ è½½é…ç½®
function loadConfig() {
  try {
    if (fs.existsSync(CONFIG_FILE)) {
      const config = JSON.parse(fs.readFileSync(CONFIG_FILE, 'utf8'));
      return { ...DEFAULT_TOOLS, ...config.tools };
    }
  } catch (e) {
    console.warn('Failed to load config:', e.message);
  }
  return DEFAULT_TOOLS;
}

// æ£€æŸ¥ tmux æ˜¯å¦å®‰è£…
function checkTmux() {
  return new Promise((resolve) => {
    const proc = spawn('which', ['tmux'], { stdio: 'pipe' });
    proc.on('close', (code) => {
      resolve(code === 0);
    });
    proc.on('error', () => {
      resolve(false);
    });
  });
});

// å®‰è£… tmux
async function installTmux() {
  console.log('ğŸ”§ Installing tmux...');
  return new Promise((resolve) => {
    const proc = spawn('brew', ['install', 'tmux'], { stdio: 'inherit' });
    proc.on('close', (code) => {
      resolve(code === 0);
    });
  });
}

// åœ¨ tmux ä¸­å¯åŠ¨å·¥å…·
async function launchInTmux(sessionName, command) {
  const tmuxExists = await checkTmux();
  if (!tmuxExists) {
    const installed = await installTmux();
    if (!installed) {
      console.error('âŒ Failed to install tmux');
      process.exit(1);
    }
  }

  // æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²å­˜åœ¨
  const check = spawn('tmux', ['has-session', '-t', sessionName], { stdio: 'pipe' });
  
  return new Promise((resolve) => {
    check.on('close', (code) => {
      if (code === 0) {
        console.log(`ğŸ“ Session "${sessionName}" exists, attaching...`);
        spawn('tmux', ['attach-session', '-t', sessionName], { stdio: 'inherit' });
      } else {
        console.log(`ğŸš€ Starting ${command} in tmux session "${sessionName}"...`);
        spawn('tmux', ['new-session', '-d', '-s', sessionName, command], { stdio: 'inherit' });
        console.log(`âœ… ${command} started in tmux session "${sessionName}"`);
        console.log(`   Run: tmux attach -t ${sessionName}`);
      }
      resolve();
    });
  });
}

// å¸®åŠ©ä¿¡æ¯
function showHelp() {
  console.log(`
ğŸ¤– Agent Launcher - Launch AI tools in tmux

Usage: diffviewer <command> [options]

Commands:
  opencode       Launch OpenCode in tmux
  claude         Launch Claude CLI in tmux
  codex          Launch Codex CLI in tmux
  lumen          Launch Lumen diff viewer
  diff           View git diff with lumen
  list           List all available tools
  attach <name>  Attach to a tmux session
  kill <name>    Kill a tmux session
  status         Show all running sessions

Options:
  -h, --help     Show this help
  -v, --version  Show version

Examples:
  diffviewer opencode       # Start OpenCode
  diffviewer claude         # Start Claude CLI
  diffviewer attach opencode # Attach to OpenCode session

Configuration:
  Edit ~/.config/diffviewer/config.json to add custom tools.
`);
}

// ä¸»ç¨‹åº
async function main() {
  const args = process.argv.slice(2);
  const command = args[0];

  if (!command || command === '-h' || command === '--help') {
    showHelp();
    process.exit(0);
  }

  if (command === '-v' || command === '--version') {
    console.log('diffviewer v1.0.0');
    process.exit(0);
  }

  const tools = loadConfig();

  // list å‘½ä»¤
  if (command === 'list') {
    console.log('ğŸ“¦ Available tools:\n');
    Object.entries(tools).forEach(([key, tool]) => {
      console.log(`  ${key.padEnd(10)} - ${tool.description}`);
    });
    process.exit(0);
  }

  // status å‘½ä»¤
  if (command === 'status') {
    console.log('ğŸ“Š Running sessions:\n');
    const proc = spawn('tmux', ['list-sessions', '-F', '#{session_name}'], { stdio: 'pipe' });
    let sessions = '';
    proc.stdout.on('data', (data) => {
      sessions += data.toString();
    });
    proc.on('close', () => {
      if (sessions.trim()) {
        sessions.split('\n').filter(s => s.trim()).forEach(s => {
          console.log(`  â€¢ ${s}`);
        });
      } else {
        console.log('  No running sessions');
      }
    });
    process.exit(0);
  }

  // attach å‘½ä»¤
  if (command === 'attach') {
    const sessionName = args[1] || 'opencode';
    console.log(`ğŸ“ Attaching to ${sessionName}...`);
    spawn('tmux', ['attach-session', '-t', sessionName], { stdio: 'inherit' });
    process.exit(0);
  }

  // kill å‘½ä»¤
  if (command === 'kill') {
    const sessionName = args[1] || 'opencode';
    console.log(`ğŸ’€ Killing session ${sessionName}...`);
    spawn('tmux', ['kill-session', '-t', sessionName], { stdio: 'inherit' });
    process.exit(0);
  }

  // diff å‘½ä»¤
  if (command === 'diff') {
    const sessionName = 'opencode-diff-viewer';
    console.log('ğŸ“Š Viewing git diff with lumen...');
    await launchInTmux(sessionName, 'lumen diff');
    process.exit(0);
  }

  // æŸ¥æ‰¾å·¥å…·
  const tool = tools[command];
  if (tool) {
    const sessionName = command;
    const cmd = tool.command || command;
    console.log(`ğŸš€ Launching ${tool.name}...`);
    await launchInTmux(sessionName, cmd);
  } else {
    console.error(`âŒ Unknown command: ${command}`);
    console.log('Run "diffviewer --help" for usage');
    process.exit(1);
  }
}

main().catch(console.error);
