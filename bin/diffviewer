#!/usr/bin/env node

const { spawn } = require('child_process');
const path = require('path');

const DEFAULT_TOOLS = {
  opencode: { name: 'OpenCode', command: 'opencode', description: 'AI-powered code editor' },
  claude: { name: 'Claude CLI', command: 'claude', description: 'Anthropic CLI' },
  codex: { name: 'Codex CLI', command: 'codex', description: 'OpenAI CLI' },
  lumen: { name: 'Lumen', command: 'lumen diff', description: 'TUI Diff Viewer' }
};

function checkTmux() {
  return new Promise((resolve) => {
    const proc = spawn('which', ['tmux'], { stdio: 'pipe' });
    proc.on('close', (code) => resolve(code === 0));
    proc.on('error', () => resolve(false));
  });
}

async function installTmux() {
  console.log('Installing tmux...');
  return new Promise((resolve) => {
    const proc = spawn('brew', ['install', 'tmux'], { stdio: 'inherit' });
    proc.on('close', (code) => resolve(code === 0));
  });
}

async function launchInTmux(sessionName, command) {
  if (!await checkTmux()) {
    const installed = await installTmux();
    if (!installed) {
      console.error('Failed to install tmux');
      process.exit(1);
    }
  }
  
  const check = spawn('tmux', ['has-session', '-t', sessionName], { stdio: 'pipe' });
  
  return new Promise((resolve) => {
    check.on('close', (code) => {
      if (code === 0) {
        console.log('Session "' + sessionName + '" exists, attaching...');
        spawn('tmux', ['attach-session', '-t', sessionName], { stdio: 'inherit' });
      } else {
        console.log('Starting ' + command + ' in tmux session "' + sessionName + '"...');
        spawn('tmux', ['new-session', '-d', '-s', sessionName, command], { stdio: 'inherit' });
        console.log(command + ' started');
        console.log('Run: tmux attach -t ' + sessionName);
      }
      resolve();
    });
  });
}

function showHelp() {
  console.log('Usage: diffviewer <command>\n\nCommands:\n  opencode  - Launch OpenCode\n  claude    - Launch Claude CLI\n  codex     - Launch Codex CLI\n  lumen     - Launch Lumen diff\n  diff      - View git diff\n  status    - Show running sessions\n  attach    - Attach to session\n  kill      - Kill session\n  list      - List tools');
}

async function main() {
  const args = process.argv.slice(2);
  const command = args[0];

  if (!command || command === '-h' || command === '--help') {
    showHelp();
    process.exit(0);
  }

  if (command === '-v' || command === '--version') {
    console.log('diffviewer v1.0.0');
    process.exit(0);
  }

  if (command === 'list') {
    Object.entries(DEFAULT_TOOLS).forEach(([key, tool]) => {
      console.log('  ' + key + ' - ' + tool.description);
    });
    process.exit(0);
  }

  if (command === 'status') {
    const proc = spawn('tmux', ['list-sessions', '-F', '#{session_name}'], { stdio: 'pipe' });
    let sessions = '';
    proc.stdout.on('data', (data) => { sessions += data.toString(); });
    proc.on('close', () => {
      console.log(sessions || '  No running sessions');
    });
    process.exit(0);
  }

  if (command === 'attach') {
    spawn('tmux', ['attach-session', '-t', (args[1] || 'opencode')], { stdio: 'inherit' });
    process.exit(0);
  }

  if (command === 'kill') {
    spawn('tmux', ['kill-session', '-t', (args[1] || 'opencode')], { stdio: 'inherit' });
    process.exit(0);
  }

  if (command === 'diff') {
    await launchInTmux('opencode-diff-viewer', 'lumen diff');
    process.exit(0);
  }

  const tool = DEFAULT_TOOLS[command];
  if (tool) {
    await launchInTmux(command, tool.command);
  } else {
    console.error('Unknown command: ' + command);
    process.exit(1);
  }
}

main().catch(console.error);
